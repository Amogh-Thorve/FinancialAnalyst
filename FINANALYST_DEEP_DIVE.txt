================================================================================
FINANALYST: THE COMPLETE TECHNICAL DEEP DIVE
================================================================================

1. PROJECT OVERVIEW
-------------------
FinAnalyst is an "Agentic" financial reasoning system. It transforms 
unstructured financial data (PDF reports) or simple stock tickers into 
a comprehensive, verified dashboard. It uses a multi-layered approach:
AI Reasoning -> Real-time Data Enrichment -> Automated Validation.

2. MODULE-BY-MODULE BREAKDOWN
-----------------------------

A. server.py (The Gateway)
- Framework: FastAPI
- Core Logic: 
  * Manages global `FinancialAnalystAgent` state.
  * /api/init: Bootstraps the agent with Groq and Alpha Vantage keys.
  * /api/upload: Receives PDF, hands it to `pdf_processor`, extracts text,
    and then triggers the Agent's extraction sequence.
  * /api/analyze: Pure ticker-based entry point. Triggers `analyze_stock`.
  * /api/chat: A streaming endpoint using `StreamingResponse`. It permits
    real-time "thinking" feedback from the LLM.
  * /api/export_pdf: Triggers `report_generator` to save the session history.

B. agent.py (The Orchestrator)
- Logic Flow:
  1. Initialization: Binds LangChain tools (`stock_lookup`, `forecast_stock`,
     `plot_chart`) to the Groq LLM.
  2. extract_metadata:
     - Uses Regex to scan the first 8000 chars for patterns like "Ticker: XXX".
     - Uses LLM as a fallback to identify the company name and currency.
     - Performs `_validate_ticker` to ensure the identified ticker matches
       the company name via Alpha Vantage's SYMBOL_SEARCH.
  3. extract_metrics:
     - The "Master Extraction" function.
     - Fetches real-time data via `_fetch_realtime_metrics`.
     - Prompts the LLM with a complex JSON template and injects the LIVE
       API data as the "Absolute Source of Truth".
     - Triggers the `SentimentAnalyzer` and `MetricsValidator`.
  4. analyze_stock:
     - Synthetic context generation. When no PDF is uploaded, it creates a
       virtual "Financial Report" by fetching overview data and using
       Web Search fallbacks (Google).
  5. Fallback Mechanism (_fetch_overview_via_search):
     - If Alpha Vantage lacks data (common for small-cap or international
       symbols), it scrapes Google snippets and uses the LLM to parse 
       financial figures from the search results.

C. sentiment_tool.py (The Market Pulse)
- Data Source: NewsAPI (Everything endpoint).
- Strategy: Cascading searches.
  1. Ticker + "stock/market/finance" keywords.
  2. Company Name (broad search).
  3. Ticker only.
- Scoring Engine: NLTK VADER.
  * Weighted Average: Newer articles are weighted more heavily in the 
    current sentiment score.
  * Trend Calculation: Maps last 7 days of articles into a score array
    for Chart.js visualization.

D. metrics_validator.py (The Fact Checker)
- Role: Defends against LLM "hallucinations".
- Mechanism:
  1. Uses specific Regex patterns (e.g., r'net\s+income') to find numbers
     within a 200-character context window in the raw PDF text.
  2. Re-calculates ratios (EPS, ROE, D/E) using the numbers it found.
  3. Compares the re-calculated "Truth" against the LLM's "Extraction".
  4. Assigns confidence:
     - VERIFIED (match within 10%)
     - CLOSE (match within 30%)
     - MISMATCH (large discrepancy)

E. pdf_processor.py & report_generator.py (IO layer)
- Processor: Uses `pypdf.PdfReader` to iterate through pages and 
  concatenate raw text into one string for the Agent context.
- Generator: Uses `reportlab.platypus` to build a PDF story.
  * Handles [IMAGE] and [CHART] markers in chat history.
  * Formats Human vs. AI messages with distinct background colors.

3. DATA FLOW & CONNECTIVITY
---------------------------

[PDF Upload] -> [pdf_processor] -> [agent.extract_metadata]
                                             |
                                             v
[Alpha Vantage SYMBOL_SEARCH] <--- [Ticker Validation]
                                             |
                                             v
[agent.extract_metrics] <--------- [Alpha Vantage OVERVIEW/CASH_FLOW]
         |
         +--> [sentiment_tool] -> [NewsAPI] -> [VADER Scoring]
         |
         +--> [metrics_validator] -> [Regex Scan] -> [Ratio Calculation]
         |
         v
[Final JSON Dashboard Data] -> [Frontend app.js] -> [Chart.js Rendering]

4. INTERNAL "SMARTS"
--------------------
- Risk Radar: Based on a deterministic 0-100 score across 4 pillars.
  Heuristics are derived from Current Ratio (Liquidity), Beta (Market), 
  Debt/Equity (Credit), and Insider Ownership (Governance).
- Red Flag Calculation: If the LLM fails to state red flags, the Agent
  infers them numerically (e.g., "P/E > 45" triggers "Extremely High 
  Valuation").

5. EXTERNAL COMPONENTS USED
---------------------------
- Groq Llama 3.1: Central LLM logic.
- Alpha Vantage: Real-time price, history, fundamentals.
- NewsAPI: Global news aggregation.
- NLTK (VADER): Natural language processing for sentiment.
- Chart.js: Frontend visualization engine.
- FastAPI: Backend API layer.
- ReportLab: PDF generation engine.

6. STABILITY SCORING METHODOLOGY
-------------------------------
The "Financial Stability Benchmarking" chart uses a normalized 0-100 scale.
A score of 60 represents the "Healthy Threshold" or industry standard.

A. Liquidity (Current Ratio)
- Formula: (Current Ratio / 1.2) * 60
- Target: 1.20 (Indicates assets exceed liabilities by 20%)

B. Solvency (Debt to Equity)
- Formula (Ratio <= 2.0): 60 + ((2.0 - Ratio) / 2.0) * 40
- Formula (Ratio > 2.0): 60 - ((Ratio - 2.0) / 2.0) * 60
- Target: 2.00 (Risk increases exponentially as ratio climbs)

C. Market Risk (Beta)
- Formula (Beta <= 1.3): 60 + ((1.3 - Beta) / 1.3) * 40
- Formula (Beta > 1.3): 60 - ((Beta - 1.3) / 1.3) * 60
- Target: 1.30 (Lower Beta = Higher Score)

D. Confidence (Insider Ownership)
- Formula: (Ownership % / 10) * 60
- Target: 10% (Revised for realistic large-cap metrics)
- Note: Thresholds above 10% for public firms indicate strong alignment.

7. DETERMINISTIC RISK SCORING (CLIENT-SIDE)
-------------------------------------------
To ensure consistent outputs, risk scores are calculated in the frontend:

A. Liquidity Risk: 100 - (Current Ratio / 1.5) * 100
B. Market Risk:    Beta * 50
C. Credit Risk:    (Debt/Equity / 3) * 100
D. Governance Risk: 100 - (Ownership / 20) * 100

Overall Risk Score (0-10): Average of all four / 10

================================================================================
END OF DOCUMENT
================================================================================
